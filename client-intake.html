<script>
    // Body Diagram Canvas
    const bodyCanvas = document.getElementById("bodyCanvas");
    const bodyCtx = bodyCanvas.getContext("2d");
    const bodyImage = new Image();
    bodyImage.src = "body-diagram.png";
    bodyImage.onload = () => bodyCtx.drawImage(bodyImage, 0, 0, bodyCanvas.width, bodyCanvas.height);
    setupDrawing(bodyCanvas, bodyCtx);

    // Signature Canvases
    const custCanvas = document.getElementById("customerSign");
    const custCtx = custCanvas.getContext("2d");
    setupDrawing(custCanvas, custCtx);

    const therCanvas = document.getElementById("therapistSign");
    const therCtx = therCanvas.getContext("2d");
    setupDrawing(therCanvas, therCtx);

    // Drawing function for both mouse and touch
    function setupDrawing(canvas, ctx) {
        let drawing = false;

        // Get coordinates adjusted for canvas position
        function getCoords(e) {
            const rect = canvas.getBoundingClientRect();
            if (e.touches && e.touches.length > 0) {
                return {
                    x: e.touches[0].clientX - rect.left,
                    y: e.touches[0].clientY - rect.top
                };
            } else {
                return {
                    x: e.offsetX,
                    y: e.offsetY
                };
            }
        }

        // Mouse Events
        canvas.addEventListener("mousedown", (e) => {
            drawing = true;
            ctx.beginPath();
            const { x, y } = getCoords(e);
            ctx.moveTo(x, y);
        });
        canvas.addEventListener("mouseup", () => {
            drawing = false;
            ctx.closePath(); // Optional: close the path
        });
        canvas.addEventListener("mouseout", () => {
            drawing = false;
            ctx.closePath(); // Optional: close the path
        });
        canvas.addEventListener("mousemove", (e) => {
            if (!drawing) return;
            const { x, y } = getCoords(e);
            ctx.lineWidth = 2;
            ctx.lineCap = "round";
            ctx.strokeStyle = "blue";
            ctx.lineTo(x, y);
            ctx.stroke();
            // To ensure continuous line from current point
            ctx.beginPath();
            ctx.moveTo(x, y);
        });

        // Touch Events
        canvas.addEventListener("touchstart", (e) => {
            e.preventDefault(); // Prevent scrolling when drawing
            drawing = true;
            ctx.beginPath();
            const { x, y } = getCoords(e);
            ctx.moveTo(x, y);
        });
        canvas.addEventListener("touchend", () => {
            drawing = false;
            ctx.closePath(); // Optional: close the path
        });
        canvas.addEventListener("touchcancel", () => { // When touch is interrupted
            drawing = false;
            ctx.closePath();
        });
        canvas.addEventListener("touchmove", (e) => {
            e.preventDefault(); // Prevent scrolling when drawing
            if (!drawing) return;
            const { x, y } = getCoords(e);
            ctx.lineWidth = 2;
            ctx.lineCap = "round";
            ctx.strokeStyle = "blue";
            ctx.lineTo(x, y);
            ctx.stroke();
            // To ensure continuous line from current point
            ctx.beginPath();
            ctx.moveTo(x, y);
        });
    }

    // Clear function
    function clearCanvas(id, ctx, bgImage = null) {
        const canvas = document.getElementById(id);
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        if (bgImage) ctx.drawImage(bgImage, 0, 0, canvas.width, canvas.height);
    }

    // Function to capture canvas data and then submit the form
    function captureCanvasData() {
        // Populate the hidden input fields with data URLs from the canvases
        document.getElementById("bodyDrawing").value = bodyCanvas.toDataURL("image/png");
        document.getElementById("customerSignature").value = custCanvas.toDataURL("image/png");
        document.getElementById("therapistSignature").value = therCanvas.toDataURL("image/png");
    }
</script>
